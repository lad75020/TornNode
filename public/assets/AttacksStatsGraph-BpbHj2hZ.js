import{j as c,o as q}from"./index-BypqA20B.js";import{r as n}from"./vendor-react-BGsnWRWU.js";import{f as J}from"./dateFilterUtil-DgyJ2LTd.js";import{u as M}from"./useChartTheme-0-n_Utvk.js";import{d as G,C as H,a as W,L as Y,B as Z,p as K,c as Q}from"./vendor-chart-BMU4AhuH.js";import"./chartTheme-DLOnjtYC.js";H.register(W,Y,Z,K,Q);const C=1440*60,U=1716574650,V="AttacksStatsDB",d="attacks_stats";function st({darkMode:j,wsMessages:i,sendWs:D,dateFrom:f,dateTo:h,onMinDate:w}){const[L,O]=n.useState({datasets:[]}),[B,u]=n.useState(!0),[g,k]=n.useState(!1),[m,R]=n.useState(!1),[N,_]=n.useState(!0),{themedOptions:v}=M(j),p=n.useRef(new Set),y=n.useRef(new Map),A=n.useRef(U),b=n.useRef(!1),E=n.useRef(0);async function S(){return q(V,2,{upgrade(s){if(!s.objectStoreNames.contains(d))try{const t=s.createObjectStore(d,{keyPath:"date"});try{t.createIndex("date","date")}catch{}}catch{}}})}async function T(s){try{return await s.getAll(d)}catch{return[]}}async function z(s,t){try{await s.put(d,t)}catch{}}function x(){const s=Array.from(y.current.values());if(s.sort((a,P)=>a.date.localeCompare(P.date)),s.length&&w)try{w(s[0].date)}catch{}let t=s;f&&(t=t.filter(a=>a.date>=f)),h&&(t=t.filter(a=>a.date<=h));const l=t.map(a=>a.date),e=[{label:"Wins",data:t.map(a=>a.wins||0),borderColor:"rgba(2,107,27,1)",backgroundColor:"rgba(40,167,70,1)"},{label:"Losses",data:t.map(a=>a.losses||0),borderColor:"rgba(220,53,70,1)",backgroundColor:"rgba(220,53,70,1)"},{label:"Attacks",data:t.map(a=>a.attacks||0),borderColor:"rgba(4,0,255,1)",backgroundColor:"rgba(7,68,109,1)"},{label:"Defends",data:t.map(a=>a.defends||0),borderColor:"rgba(124,90,3,1)",backgroundColor:"rgba(131,95,4,1)"}],{labels:r,datasets:o}=J(l,e,f,h);O({labels:r,datasets:o})}n.useEffect(()=>{b.current||(async()=>{u(!0);try{const e=await S();let r=0;try{const o=e.transaction(d,"readonly");r=await o.store.count(),await o.done}catch{}r===0?k(!0):R(!0)}catch{k(!0)}const s=await S(),t=await T(s);if(t.sort((e,r)=>e.date.localeCompare(r.date)),t.forEach(e=>y.current.set(e.date,e)),t.length>0){const e=t[t.length-1].date;A.current=Math.floor(new Date(e).getTime()/1e3)+C}if(x(),b.current=!0,g&&!m){u(!1);return}const l=Math.floor(Date.now()/1e3);for(let e=A.current;e<l;e+=C){const r=Math.min(e+C,l),o=new Date(e*1e3).toISOString().slice(0,10);p.current.add(o);try{D(JSON.stringify({type:"getTornAttacks",from:e,to:r}))}catch{}}p.current.size===0&&u(!1)})()},[D,g,m]);const I=()=>{R(!0),u(!0)};return n.useEffect(()=>{!i||i.length===0||(async()=>{const s=await S();let t=!1;for(let l=E.current;l<i.length;l++){const e=i[l];if(!(!e||e[0]!=="{"))try{const r=JSON.parse(e);if(r.type==="getTornAttacks"&&typeof r.from=="number"){const o=new Date(r.from*1e3).toISOString().slice(0,10);if(!y.current.has(o)){const a={date:o,wins:r.wins||0,losses:r.losses||0,attacks:r.attacks||0,defends:r.defends||0};y.current.set(o,a),await z(s,a),p.current.delete(o),t=!0}}}catch{}}E.current=i.length,t&&x(),b.current&&p.current.size===0&&u(!1)})()},[i]),n.useEffect(()=>{x()},[f,h]),c.jsxs("div",{className:"my-4",children:[c.jsx("h5",{style:{cursor:"pointer",userSelect:"none"},onClick:()=>_(s=>!s),title:"Click to show/hide chart",children:"Attacks Stats by Day"}),g&&!m?c.jsxs("div",{style:{fontSize:12,opacity:.85,display:"flex",flexDirection:"column",gap:8},children:[c.jsx("span",{children:"Aucune donn√©e d'attaques en cache local."}),c.jsx("button",{className:"btn btn-sm btn-outline-primary",style:{width:140},onClick:I,children:"Refresh"})]}):B?c.jsx("div",{children:c.jsx("img",{src:"/images/loader.gif",alt:"Chargement...",style:{maxWidth:"80px"}})}):N&&c.jsx("div",{style:{height:400},children:c.jsx(G,{data:L,options:v({responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0},title:{display:!1},tooltip:{enabled:!0}},scales:{x:{title:{display:!0,text:"Day"},type:"category"},y:{title:{display:!0,text:"Count"},beginAtZero:!0}}})})})]})}export{st as default};

import{j as u,a as V,g as _}from"./index-BypqA20B.js";import{r as f}from"./vendor-react-BGsnWRWU.js";import{u as R}from"./useChartTheme-0-n_Utvk.js";import{c as P}from"./chartTheme-DLOnjtYC.js";import{d as Z,C as z,a as H,L as J,B as Q,b as X,P as ee,e as te,p as se,c as ae}from"./vendor-chart-BMU4AhuH.js";z.register(H,J,Q,X,ee,te,se,ae);function ue({logsUpdated:K,darkMode:L,chartHeight:A=400,dateFrom:C,dateTo:T,onMinDate:D}){const[w,j]=f.useState({labels:[],sums:[]}),[M,O]=f.useState(!0),[q,U]=f.useState(!0),[i,k]=f.useState("day"),{themedOptions:E,ds:v}=R(L);f.useEffect(()=>{async function g(){U(!0);const $=await V(9020),B=await _(),S=new Map;for(const e of B)e&&typeof e.id<"u"&&S.set(Number(e.id),Number(e.price)||0);function Y(e){if(!e||typeof e!="object")return null;if(typeof e.id<"u"){const s=Number(e.id),a=Number(e.amount??e.qty??e.quantity??e.count??e.value??0);return!Number.isFinite(s)||!Number.isFinite(a)?null:{id:s,amount:a}}const t=Object.keys(e);if(t.length===1){const s=Number(t[0]);let a=e[t[0]];return a&&typeof a=="object"?a=Number(a.amount??a.qty??a.quantity??a.count??a.value??0):a=Number(a),!Number.isFinite(s)||!Number.isFinite(a)?null:{id:s,amount:a}}return null}const d={};function x(e,t,s){d[e]||(d[e]={sum:0,sortKey:t}),d[e].sum+=s}function F(e){const t=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())),s=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-s);const a=new Date(Date.UTC(t.getUTCFullYear(),0,1)),r=Math.ceil(((t-a)/864e5+1)/7);return{year:t.getUTCFullYear(),week:r}}for(const e of $){if(!e||!e.data||!e.data.items_gained)continue;let t=0;const s=e.data.items_gained;if(Array.isArray(s))for(const l of s){const o=Y(l);if(!o)continue;const n=S.get(o.id);n&&n>0&&(t+=n*o.amount)}else if(typeof s=="object")for(const l of Object.keys(s)){const o=Number(l);if(!Number.isFinite(o))continue;let n=s[l],m=0;if(n&&typeof n=="object"?m=Number(n.amount??n.qty??n.quantity??n.count??n.value??0):m=Number(n),!Number.isFinite(m)||m<=0)continue;const y=S.get(o);y&&y>0&&(t+=y*m)}if(t<=0)continue;const a=e.timestamp*1e3,r=new Date(a),h=r.toISOString().slice(0,10);if(!(C&&h<C)&&!(T&&h>T)){if(i==="day"){const l=r.toISOString().slice(0,10),o=Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate());x(l,o,t)}else if(i==="week"){const{year:l,week:o}=F(r),n=`${l}-W${String(o).padStart(2,"0")}`,m=new Date(Date.UTC(l,0,4)),y=m.getUTCDay()||7,N=new Date(m);N.setUTCDate(m.getUTCDate()-y+1);const I=new Date(N);I.setUTCDate(N.getUTCDate()+(o-1)*7);const G=I.getTime();x(n,G,t)}else if(i==="month"){const l=r.getUTCFullYear(),o=r.getUTCMonth(),n=`${l}-${String(o+1).padStart(2,"0")}`,m=Date.UTC(l,o,1);x(n,m,t)}}}const c=Object.entries(d).map(([e,t])=>({k:e,...t}));if(!c.length){j({labels:[],sums:[]}),U(!1);return}c.sort((e,t)=>e.sortKey-t.sortKey);let p=[],b=[];if(i==="day"){let e=new Date(c[0].sortKey);const t=new Date(c[c.length-1].sortKey);for(;e.getTime()<=t.getTime();){const s=e.toISOString().slice(0,10);p.push(s),b.push(d[s]?d[s].sum:0),e.setUTCDate(e.getUTCDate()+1)}}else if(i==="week"){let e=function(a){const{year:r,week:h}=F(a);return`${r}-W${String(h).padStart(2,"0")}`},t=new Date(c[0].sortKey);const s=new Date(c[c.length-1].sortKey);for(;t.getTime()<=s.getTime();){const a=e(t);p.push(a),b.push(d[a]?d[a].sum:0),t.setUTCDate(t.getUTCDate()+7)}}else if(i==="month"){let e=new Date(c[0].sortKey);const t=new Date(c[c.length-1].sortKey);for(;e.getTime()<=t.getTime();){const s=`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}`;p.push(s),b.push(d[s]?d[s].sum:0),e.setUTCMonth(e.getUTCMonth()+1),e.setUTCDate(1)}}if(i==="day"&&p.length&&D&&/^\d{4}-\d{2}-\d{2}$/.test(p[0]))try{D(p[0])}catch{}j({labels:p,sums:b}),U(!1)}g()},[K,i,C,T,D]);const{cumulative:W}=P(w.sums);return u.jsxs("div",{className:"my-4",children:[u.jsxs("h5",{style:{cursor:"pointer",userSelect:"none"},onClick:()=>O(g=>!g),title:"Click to show/hide chart",children:["Items Value Gained per ",i]}),q?u.jsx("div",{children:u.jsx("img",{src:"/images/loader.gif",alt:"Loading...",style:{maxWidth:"80px"}})}):M&&u.jsxs("div",{style:{display:"flex",gap:8,height:A},children:[u.jsx("div",{style:{display:"flex",flexDirection:"column",gap:6},children:u.jsxs("div",{className:"btn-group-vertical",role:"group","aria-label":"Granularity",children:[u.jsx("button",{type:"button",className:`btn btn-sm ${i==="day"?"btn-primary":"btn-outline-primary"}`,onClick:()=>k("day"),children:"Daily"}),u.jsx("button",{type:"button",className:`btn btn-sm ${i==="week"?"btn-primary":"btn-outline-primary"}`,onClick:()=>k("week"),children:"Weekly"}),u.jsx("button",{type:"button",className:`btn btn-sm ${i==="month"?"btn-primary":"btn-outline-primary"}`,onClick:()=>k("month"),children:"Monthly"})]})}),u.jsx("div",{style:{flex:1},children:u.jsx(Z,{data:{labels:w.labels,datasets:[v("bar",0,w.sums,{label:"Value Sum",backgroundColor:"rgba(255,206,86,0.6)",borderColor:"rgba(255,206,86,1)",borderWidth:1}),v("line",1,W,{label:"Cumulative",borderColor:"rgba(54,162,235,0.9)",backgroundColor:"rgba(54,162,235,0.3)",yAxisID:"y1",pointRadius:2,tension:.15,fill:!1})]},options:E({responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0},title:{display:!1},tooltip:{callbacks:{label(g){return`${g.dataset.label||""}: ${g.parsed.y?.toLocaleString?.()??g.parsed.y}`}}}},scales:{x:{title:{display:!0,text:i.charAt(0).toUpperCase()+i.slice(1)}},y:{title:{display:!0,text:"Value"},beginAtZero:!0},y1:{position:"right",title:{display:!0,text:"Cumulative"},beginAtZero:!0,grid:{drawOnChartArea:!1}}}})})})]})]})}export{ue as default};

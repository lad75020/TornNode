const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-BypqA20B.js","assets/vendor-react-BGsnWRWU.js","assets/vendor-chart-BMU4AhuH.js","assets/index-B0h30RSe.css"])))=>i.map(i=>d[i]);
import{_ as k,w as v,g as b,j as c}from"./index-BypqA20B.js";import{r as o}from"./vendor-react-BGsnWRWU.js";import"./vendor-chart-BMU4AhuH.js";function D(n,d,l={}){const{onSent:a}=l;try{if(typeof n=="function"){const f={type:"updatePrice",id:d},r=n(JSON.stringify(f),{bypassUpdatePrice:!0});if(a)try{a(f)}catch{}return r}}catch{}}async function R(n){if(!(!n||n.type!=="updatePrice"||!n.ok||typeof n.id>"u")&&typeof n.price=="number")try{const{getAllItemsFromIDB:d}=await k(async()=>{const{getAllItemsFromIDB:r}=await import("./index-BypqA20B.js").then(u=>u.s);return{getAllItemsFromIDB:r}},__vite__mapDeps([0,1,2,3])),l=await d();let a=!1;const f=l.map(r=>r.id===n.id?(a=!0,{...r,price:n.price}):r);a&&await v(f)}catch{}}function L({token:n,onAuth:d,onWatch:l,onUnwatch:a,watchedItems:f=[],sendWs:r,wsMessages:u}){const[h,p]=o.useState([]),[y,w]=o.useState(""),[m,j]=o.useState([]),[A,I]=o.useState(new Set),S=o.useRef(new Map);return o.useEffect(()=>{if(!n)return;let e=!1;return(async()=>{const t=await b();if(!e&&t.length){p(t);const i=parseInt(localStorage.getItem("itemsLastSync")||"0",10);if(Date.now()-i>600*1e3)try{r&&r(JSON.stringify({type:"getAllTornItems"}))}catch{}}else try{r&&r(JSON.stringify({type:"getAllTornItems"}))}catch{}})(),()=>{e=!0}},[n,r]),o.useEffect(()=>{if(!n)return;let e=localStorage.getItem("itemsLastSync");const t=setInterval(async()=>{const i=localStorage.getItem("itemsLastSync");if(i&&i!==e){e=i;const s=await b();s.length&&p(s)}},1e4);return()=>clearInterval(t)},[n]),o.useEffect(()=>{const e=(y||"").toLowerCase();j(h.filter(t=>(t&&typeof t.name=="string"?t.name:"").toLowerCase().startsWith(e)))},[y,h]),o.useEffect(()=>{if(!u||!u.length)return;const e=u[u.length-1];if(!(!e||e[0]!=="{"))try{const t=JSON.parse(e);t.type==="updatePrice"?(t.ok&&typeof t.id<"u"&&typeof t.price=="number"&&p(i=>i.map(s=>s.id===t.id?{...s,price:t.price}:s)),R(t).catch(()=>{})):t.type==="getAllTornItems"&&t.ok&&Array.isArray(t.items)&&p(t.items)}catch{}},[u]),n||(location.href="/"),c.jsxs("div",{style:{margin:20},children:[c.jsx("input",{type:"text",value:y,onChange:e=>w(e.target.value),placeholder:"Rechercher...",style:{padding:8,width:200}}),y&&c.jsxs("ul",{style:{color:"black",border:"1px solid #ccc",padding:0,margin:0,width:200,position:"absolute",background:"#fff",zIndex:1,maxHeight:300,overflowY:"auto"},children:[m.length===0&&c.jsx("li",{style:{listStyle:"none",padding:8,fontStyle:"italic",opacity:.6},children:"Aucun résultat"}),m.map(e=>c.jsxs("li",{style:{listStyle:"none",padding:8,cursor:"pointer",display:"flex",alignItems:"center"},title:e.description||"",onClick:()=>{f.includes(e.id)?a&&a(e.id):l&&l(e.id)},children:[c.jsx("input",{type:"checkbox",className:"form-check-input me-2",checked:f.includes(e.id),onClick:t=>t.stopPropagation(),onChange:t=>{t.stopPropagation(),t.target.checked?l&&l(e.id):a&&a(e.id)}}),e.img64&&c.jsx("img",{src:`data:image/png;base64,${e.img64}`,alt:e.name,style:{width:32,height:32,marginRight:8,objectFit:"contain",borderRadius:4}}),c.jsx("span",{style:{flex:1},children:(e.name||"#"+e.id)+(e.price!=null?" $"+e.price:"")}),c.jsx("button",{onClick:t=>{t.preventDefault(),t.stopPropagation();const i=Date.now(),s=S.current.get(e.id)||0;if(i-s<2e3)return;S.current.set(e.id,i),I(g=>new Set(g).add(e.id));const P=D(r,e.id,{onSent:()=>{}});Promise.resolve(P).finally(()=>{setTimeout(()=>I(g=>{const x=new Set(g);return x.delete(e.id),x}),400)})},className:"btn btn-link p-0 ms-2",style:{textDecoration:"none"},title:"Rafraîchir le prix",children:A.has(e.id)?"⏳":"🔄"})]},e.id))]})]})}export{L as default};

import{o as _,j as i}from"./index-BypqA20B.js";import{r as d}from"./vendor-react-BGsnWRWU.js";import{u as P}from"./useChartTheme-0-n_Utvk.js";import{c as Z}from"./chartTheme-DLOnjtYC.js";import{d as q,C as z,a as H,L as J,B as Q,e as X,p as ee,c as te}from"./vendor-chart-BMU4AhuH.js";z.register(H,J,Q,X,ee,te);function ce({logsUpdated:M,darkMode:O,chartHeight:L=400,dateFrom:p,dateTo:y,onMinDate:K}){const[N,C]=d.useState(!0),[A,W]=d.useState(!0),{themedOptions:E,ds:k}=P(O),[f,D]=d.useState([]),[h,T]=d.useState([]),[l,S]=d.useState("day");d.useMemo(()=>h.reduce((r,c)=>r+c,0),[h]);const{cumulative:Y,average:B}=d.useMemo(()=>Z(h),[h]);return d.useEffect(()=>{let r=!0;return(async()=>{try{C(!0);const c=await _("LogsDB"),b="logs";if(!c.objectStoreNames.contains(b)){r&&(D([]),T([]),C(!1));return}const x=c.transaction(b,"readonly"),I=await x.store.index("log").getAll(6e3);await x.done;const j=I.filter(u=>u&&typeof u.timestamp=="number"&&u.data&&typeof u.data.duration=="number").sort((u,s)=>u.timestamp-s.timestamp),F=j.map(u=>new Date(u.timestamp*1e3).toISOString()),G=j.map(u=>Math.floor(u.data.duration/60));if(r){let u=function(n){const e=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate())),o=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-o);const t=new Date(Date.UTC(e.getUTCFullYear(),0,1)),a=Math.ceil(((e-t)/864e5+1)/7);return{year:e.getUTCFullYear(),week:a}};D(F),T(G),C(!1);const s={};for(const n of j){const e=new Date(n.timestamp*1e3),o=Math.floor(n.data.duration/60);if(Number.isFinite(o)){if(l==="day"){const t=e.toISOString().slice(0,10),a=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate());s[t]||(s[t]={total:0,sortKey:a}),s[t].total+=o}else if(l==="week"){const{year:t,week:a}=u(e),g=`${t}-W${String(a).padStart(2,"0")}`,m=new Date(Date.UTC(t,0,4)),R=m.getUTCDay()||7,v=new Date(m);v.setUTCDate(m.getUTCDate()-R+1);const $=new Date(v);$.setUTCDate(v.getUTCDate()+(a-1)*7);const V=$.getTime();s[g]||(s[g]={total:0,sortKey:V}),s[g].total+=o}else if(l==="month"){const t=e.getUTCFullYear(),a=e.getUTCMonth(),g=`${t}-${String(a+1).padStart(2,"0")}`,m=Date.UTC(t,a,1);s[g]||(s[g]={total:0,sortKey:m}),s[g].total+=o}}}let w=[],U=[];if(Object.keys(s).length>0){if(l==="day"){const n=Object.entries(s).map(([t,a])=>({k:t,...a})).sort((t,a)=>t.sortKey-a.sortKey);let e=new Date(n[0].sortKey);const o=new Date(n[n.length-1].sortKey);for(;e.getTime()<=o.getTime();){const t=e.toISOString().slice(0,10);w.push(t),U.push(s[t]?s[t].total:0),e.setUTCDate(e.getUTCDate()+1)}}else if(l==="week"){let n=function(a){const{year:g,week:m}=u(a);return`${g}-W${String(m).padStart(2,"0")}`};const e=Object.entries(s).map(([a,g])=>({k:a,...g})).sort((a,g)=>a.sortKey-g.sortKey);let o=new Date(e[0].sortKey);const t=new Date(e[e.length-1].sortKey);for(;o.getTime()<=t.getTime();){const a=n(o);w.push(a),U.push(s[a]?s[a].total:0),o.setUTCDate(o.getUTCDate()+7)}}else if(l==="month"){const n=Object.entries(s).map(([t,a])=>({k:t,...a})).sort((t,a)=>t.sortKey-a.sortKey);let e=new Date(n[0].sortKey);const o=new Date(n[n.length-1].sortKey);for(;e.getTime()<=o.getTime();){const t=`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}`;w.push(t),U.push(s[t]?s[t].total:0),e.setUTCMonth(e.getUTCMonth()+1),e.setUTCDate(1)}}}r&&(D(w),T(U),C(!1))}}catch(c){console.error("TravelDurationGraph error:",c),r&&(D([]),T([]),C(!1))}})(),()=>{r=!1}},[M,l]),d.useEffect(()=>{if(l==="day"&&f.length){if(K&&/^\d{4}-\d{2}-\d{2}$/.test(f[0]))try{K(f[0])}catch{}!p&&!y||(D(r=>r.filter((c,b)=>!(p&&c<p||y&&c>y))),T(r=>{const c=[];return f.forEach((b,x)=>{p&&b<p||y&&b>y||c.push(r[x])}),c}))}},[p,y,l,f.length]),i.jsxs("div",{className:"my-4",children:[i.jsx("h5",{style:{cursor:"pointer",userSelect:"none"},onClick:()=>W(r=>!r),title:"Click to show/hide chart",children:"Travel Time"}),N?i.jsx("div",{children:i.jsx("img",{src:"/images/loader.gif",alt:"Loading...",style:{maxWidth:"80px"}})}):A&&i.jsx(i.Fragment,{children:i.jsxs("div",{style:{display:"flex",gap:"8px",height:L},children:[i.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:i.jsxs("div",{className:"btn-group-vertical",role:"group","aria-label":"Granularity",children:[i.jsx("button",{type:"button",className:`btn btn-sm ${l==="day"?"btn-primary":"btn-outline-primary"}`,onClick:()=>S("day"),children:"Daily"}),i.jsx("button",{type:"button",className:`btn btn-sm ${l==="week"?"btn-primary":"btn-outline-primary"}`,onClick:()=>S("week"),children:"Weekly"}),i.jsx("button",{type:"button",className:`btn btn-sm ${l==="month"?"btn-primary":"btn-outline-primary"}`,onClick:()=>S("month"),children:"Monthly"})]})}),i.jsx("div",{style:{flex:1},children:i.jsx(q,{data:{labels:f,datasets:[k("bar",0,h,{label:"Durée (min)",backgroundColor:"rgba(54, 162, 235, 0.6)",borderColor:"rgba(54, 162, 235, 1)",borderWidth:1}),k("line",1,Y,{label:"Cumul (min)",borderColor:"rgba(255, 159, 64, 0.9)",backgroundColor:"rgba(255, 159, 64, 0.3)",yAxisID:"y1",pointRadius:2,tension:.15,fill:!1}),k("line",2,h.map(()=>B),{label:"Moyenne (min)",borderColor:"rgba(153, 102, 255, 0.9)",backgroundColor:"rgba(153, 102, 255, 0.3)",borderDash:[5,4],pointRadius:0,tension:0,fill:!1})]},options:E({responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0},title:{display:!1},tooltip:{callbacks:{title(r){return!r||!r.length?"":r[0].label},label(r){return`${r.dataset.label||""}: ${r.parsed.y} min`}}}},scales:{x:{title:{display:!0,text:l.charAt(0).toUpperCase()+l.slice(1)},stacked:!1},y:{title:{display:!0,text:"Durée (min)"},beginAtZero:!0,stacked:!1},y1:{position:"right",title:{display:!0,text:"Cumul (min)"},beginAtZero:!0,grid:{drawOnChartArea:!1}}}})})})]})})]})}export{ce as default};

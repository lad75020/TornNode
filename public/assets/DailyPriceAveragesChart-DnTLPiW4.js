import{j as y,C as $}from"./index-BypqA20B.js";import{r as a}from"./vendor-react-BGsnWRWU.js";import{u as X}from"./useChartTheme-0-n_Utvk.js";import"./vendor-chart-BMU4AhuH.js";import"./chartTheme-DLOnjtYC.js";function B(f){return`hsl(${f*137%360}deg 65% 50%)`}function I(f){let i=f;if(i&&typeof i=="object"&&("$date"in i?i=i.$date:i.date&&(i=i.date)),typeof i=="number"){const d=new Date(i);if(!isNaN(d))return{ts:d.getTime(),day:d.toISOString().slice(0,10)}}if(typeof i=="string"){if(/^\d{4}-\d{2}-\d{2}$/.test(i))return{ts:Date.UTC(+i.slice(0,4),+i.slice(5,7)-1,+i.slice(8,10)),day:i};const d=i.replace(" ","T"),m=Date.parse(d);if(!isNaN(m)){const T=new Date(m).toISOString().slice(0,10);return{ts:m,day:T}}}return{ts:NaN,day:null}}function M({wsMessages:f,sendWs:i,darkMode:d,onMinDate:m,dateFrom:T,dateTo:C}){const[g,D]=a.useState([]),[u,P]=a.useState(null),{theme:E}=X(d),W=d?"#121417":"#ffffff";a.useEffect(()=>{i&&i("dailyPriceAveragesAll")},[i]),a.useEffect(()=>{if(!f.length)return;const e=f[f.length-1];if(!(!e||e[0]!=="{"))try{const t=JSON.parse(e);t.type==="dailyPriceAveragesAll"&&t.ok&&Array.isArray(t.lines)&&(D(t.lines),!u&&t.lines.length&&P(t.lines[0].id))}catch{}},[f]),a.useMemo(()=>{const e=[];g.forEach(n=>n.points.forEach(o=>{const{day:c}=I(o.date);c&&e.push(c)}));const t=Array.from(new Set(e)).sort();return t.length&&m&&m(t[0]),t},[g,m]);const l=a.useMemo(()=>{if(!g.length)return[];const e=[];g.forEach(r=>r.points.forEach(S=>{const{ts:v}=I(S.date);isNaN(v)||e.push(v)}));const t=e.length>0;let n=t?Math.min(...e):0,o=t?Math.max(...e):(g[0]?.points.length||1)-1;n===o&&(o=n+1);const c=T?I(T).ts:n,j=C?I(C).ts+24*3600*1e3-1:o;return g.map(r=>{let S=-1;const v=r.points.map(b=>{S+=1;const{ts:x}=I(b.date),A=typeof b.avg=="number"?b.avg:Number(b.avg);return t&&!isNaN(x)?x<c||x>j?null:{x:(x-n)/(o-n),y:A}:{x:r.points.length>1?S/(r.points.length-1):0,y:A}}).filter(Boolean);return{id:r.id,name:r.name||String(r.id),color:B(r.id),points:v}})},[g,T,C]),F=a.useMemo(()=>{const e=t=>t.name||String(t.id);return l.slice().sort((t,n)=>e(t).localeCompare(e(n),void 0,{sensitivity:"base"}))},[l]),w=a.useMemo(()=>u?l.filter(e=>String(e.id)===String(u)):l.slice(0,1),[l,u]);a.useEffect(()=>{l.length&&!l.some(e=>String(e.id)===String(u))&&P(l[0].id)},[l,u]);const k=a.useMemo(()=>{let e=1/0,t=-1/0;return w.forEach(n=>n.points.forEach(o=>{o.y<e&&(e=o.y),o.y>t&&(t=o.y)})),!isFinite(e)||!isFinite(t)?{min:0,max:1}:(e===t&&(e-=1,t+=1),{min:e,max:t})},[w]);return y.jsxs("div",{style:{height:$,width:"100%",position:"relative",fontSize:12},children:[y.jsx("canvas",{style:{width:"100%",height:"100%",background:W},ref:e=>{if(!e)return;const t=e.getContext("2d"),n=e.width=e.clientWidth*(window.devicePixelRatio||1),o=e.height=e.clientHeight*(window.devicePixelRatio||1);t.scale(window.devicePixelRatio||1,window.devicePixelRatio||1),t.clearRect(0,0,n,o),w.some(s=>s.points.length)||(t.fillStyle=E.text||"#888",t.font="14px sans-serif",t.fillText("Aucun point valide (dates non reconnues ?)",50,60)),t.strokeStyle=E.grid||"#ccc",t.lineWidth=1,t.beginPath(),t.moveTo(40,10),t.lineTo(40,o-30),t.lineTo(n-10,o-30),t.stroke();const{min:c,max:j}=k,r=n-50,S=o-40,v=40,b=10,x=s=>b+(1-(s-c)/(j-c))*S,A=s=>v+s*r;t.fillStyle=E.text||"#fff",t.font="10px sans-serif";for(let s=0;s<=5;s++){const h=c+s/5*(j-c),p=x(h);t.strokeStyle=E.grid||"#444",t.beginPath(),t.moveTo(40,p),t.lineTo(n-10,p),t.stroke(),t.fillText(h.toFixed(0),2,p+3)}w.forEach(s=>{s.points.length&&(t.strokeStyle=s.color,t.lineWidth=1.5,t.beginPath(),s.points.forEach((h,p)=>{const z=A(h.x),H=x(h.y);p===0?t.moveTo(z,H):t.lineTo(z,H)}),t.stroke())});let N=50,R=14;const O=14,Y=n-60;w.slice(0,50).forEach(s=>{const h=s.name,p=t.measureText(h).width+18;N+p>Y&&(N=50,R+=O),t.fillStyle=s.color,t.fillRect(N,R-10,12,12),t.fillStyle=E.text||"#fff",t.fillText(h,N+16,R),N+=p+8})}}),y.jsxs("div",{style:{position:"absolute",top:4,right:8,fontSize:11,opacity:.7},children:[l.length," items • Item sélectionné: ",u||"—"," • Y [",k.min.toFixed(0),"..",k.max.toFixed(0),"]"]}),y.jsxs("div",{style:{position:"absolute",top:8,left:50,background:"rgba(0,0,0,0.35)",backdropFilter:"blur(4px)",padding:"4px 6px",borderRadius:4,display:"flex",gap:6,alignItems:"center"},children:[y.jsx("label",{style:{fontSize:11,color:"#fff"},children:"Item:"}),y.jsx("select",{value:u||"",onChange:e=>P(e.target.value||null),style:{fontSize:11,padding:"2px 4px",maxWidth:240},children:F.map(e=>y.jsx("option",{value:e.id,children:e.name||e.id},e.id))})]})]})}export{M as default};

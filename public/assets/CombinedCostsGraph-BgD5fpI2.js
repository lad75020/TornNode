import{j as g,a as C}from"./index-BypqA20B.js";import{r as f}from"./vendor-react-BGsnWRWU.js";import{f as E}from"./dateFilterUtil-DgyJ2LTd.js";import{d as F,C as N,a as P,L as W,g as _,B as z,e as G,p as R,c as Y}from"./vendor-chart-BMU4AhuH.js";import{u as $}from"./useChartTheme-0-n_Utvk.js";import"./chartTheme-DLOnjtYC.js";N.register(P,W,_,z,G,R,Y);function K(B){const o=new Date(B+"T00:00:00Z"),p=new Date(Date.UTC(o.getUTCFullYear(),o.getUTCMonth(),o.getUTCDate()));p.setUTCDate(p.getUTCDate()+4-(p.getUTCDay()||7));const y=new Date(Date.UTC(p.getUTCFullYear(),0,1)),h=Math.ceil(((p-y)/864e5+1)/7);return`${p.getUTCFullYear()}-W${String(h).padStart(2,"0")}`}function V({logsUpdated:B,darkMode:o,chartHeight:p=400,dateFrom:y,dateTo:h,onMinDate:x}){const[u,k]=f.useState("daily"),[i,U]=f.useState({labels:[],seriesA:[],seriesB:[]}),[A,T]=f.useState({labels:[],seriesA:[],seriesB:[]}),[j,L]=f.useState({A:0,B:0}),[I,O]=f.useState(!0),{themedOptions:v}=$(o);function b(e){if(e==null)return 0;if(typeof e=="number")return isFinite(e)?e:0;if(typeof e=="string"){const n=e.replace(/[^0-9.-]/g,""),c=Number(n);return isFinite(c)?c:0}return 0}return f.useEffect(()=>{async function e(){const[n,c,a,t]=await Promise.all([C(1103),C(1104),C(1112),C(1113)]),d={},r={};for(const s of n){const l=new Date(s.timestamp*1e3).toISOString().slice(0,10),m=b(s?.data?.cost);d[l]=(d[l]||0)+m}for(const s of a){const l=new Date(s.timestamp*1e3).toISOString().slice(0,10),m=b(s?.data?.cost_total);d[l]=(d[l]||0)+m}for(const s of c){const l=new Date(s.timestamp*1e3).toISOString().slice(0,10),m=b(s?.data?.cost);r[l]=(r[l]||0)+m}for(const s of t){const l=new Date(s.timestamp*1e3).toISOString().slice(0,10),m=b(s?.data?.cost_total);r[l]=(r[l]||0)+m}const S=Array.from(new Set([...Object.keys(d),...Object.keys(r)])).sort(),w=S.map(s=>d[s]||0),D=S.map(s=>r[s]||0);U({labels:S,seriesA:w,seriesB:D});try{console.debug("[CombinedCostsGraph] daily labels",S.length,"A[0]",w[0],"B[0]",D[0])}catch{}L({A:w.reduce((s,l)=>s+l,0),B:D.reduce((s,l)=>s+l,0)})}e()},[B]),f.useEffect(()=>{if(!i.labels.length)return;let e=[],n=[],c=[];if(u==="daily")e=i.labels,n=i.seriesA,c=i.seriesB;else if(u==="weekly"){const a=new Map;for(let t=0;t<i.labels.length;t++){const d=K(i.labels[t]),r=a.get(d)||{A:0,B:0};r.A+=i.seriesA[t],r.B+=i.seriesB[t],a.set(d,r)}e=Array.from(a.keys()),n=e.map(t=>a.get(t).A),c=e.map(t=>a.get(t).B)}else if(u==="monthly"){const a=new Map;for(let t=0;t<i.labels.length;t++){const d=i.labels[t].slice(0,7),r=a.get(d)||{A:0,B:0};r.A+=i.seriesA[t],r.B+=i.seriesB[t],a.set(d,r)}e=Array.from(a.keys()),n=e.map(t=>a.get(t).A),c=e.map(t=>a.get(t).B)}if(u==="daily"&&e.length&&x&&/^\d{4}-\d{2}-\d{2}$/.test(e[0]))try{x(e[0])}catch{}if(u==="daily"){const a=E(e,[{label:"Purchases",data:n},{label:"Sales",data:c}],y,h);T({labels:a.labels,seriesA:a.datasets[0].data,seriesB:a.datasets[1].data})}else T({labels:e,seriesA:n,seriesB:c})},[u,i,y,h,x]),g.jsxs("div",{className:"my-4",children:[g.jsxs("h5",{style:{cursor:"pointer",userSelect:"none"},onClick:()=>O(e=>!e),title:"Click to show/hide chart",children:["Item Market Purchases & Sales â€“ ",u]}),I&&g.jsxs(g.Fragment,{children:[g.jsxs("div",{style:{position:"relative",height:p},children:[g.jsx("div",{style:{position:"absolute",left:0,top:0,bottom:0,display:"flex",flexDirection:"column",gap:6,padding:"4px 4px",zIndex:5},children:["daily","weekly","monthly"].map(e=>g.jsx("button",{onClick:()=>k(e),style:{writingMode:"vertical-rl",transform:"rotate(180deg)",background:u===e?o?"#555":"#ddd":o?"#333":"#f5f5f5",color:o?"#fff":"#222",border:"1px solid "+(o?"#777":"#ccc"),borderRadius:4,cursor:"pointer",fontSize:11,padding:"6px 4px"},children:e},e))}),g.jsx("div",{style:{height:"100%",marginLeft:40},children:g.jsx(F,{data:{labels:A.labels,datasets:[{label:"Purchases",data:A.seriesA.map(e=>e>0?e:null),backgroundColor:o?"rgba(80,160,255,0.65)":"rgba(20,90,180,0.85)",borderColor:o?"rgba(120,190,255,1)":"rgba(30,110,200,1)",borderWidth:1},{label:"Sales",data:A.seriesB.map(e=>e>0?e:null),backgroundColor:o?"rgba(255,140,90,0.65)":"rgba(230,90,20,0.85)",borderColor:o?"rgba(255,170,130,1)":"rgba(240,110,40,1)",borderWidth:1}]},options:v({responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0},title:{display:!1}},scales:{x:{title:{display:!0,text:u==="daily"?"Day":u==="weekly"?"Week":"Month"}},y:{type:"logarithmic",title:{display:!0,text:"Sum cost (log)"},ticks:{callback:e=>{const n=Number(e),c=n/Math.pow(10,Math.floor(Math.log10(n)));return[1,2,5].includes(Math.round(c))?n.toLocaleString():""}},min:1}},interaction:{intersect:!1,mode:"index"}})})})]}),g.jsxs("div",{style:{fontSize:12,marginTop:6,opacity:.75},children:["Total Purchases: ",j.A.toLocaleString()," | Total Sales: ",j.B.toLocaleString()]})]})]})}export{V as default};

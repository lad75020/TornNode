import{j as y}from"./index-BypqA20B.js";import{r as c}from"./vendor-react-BGsnWRWU.js";import{u as q}from"./useChartTheme-0-n_Utvk.js";import{f as J,C as v,a as W,L as G,P as H,b as I,p as K,c as V}from"./vendor-chart-BMU4AhuH.js";import"./chartTheme-DLOnjtYC.js";v.register(W,G,H,I,K,V);const w=1716574650;function F({logsUpdated:k,darkMode:P,chartHeight:T=400,wsMessages:d=[],sendWs:h,dateFrom:A,dateTo:j,onMinDate:_}){const[E,L]=c.useState({labels:[],datasets:[]}),[O,S]=c.useState(!0),[$,B]=c.useState(!0),{themedOptions:N,ds:b}=q(P),p=c.useRef(!1),R=c.useRef(null),x=c.useRef(null),m=c.useRef(0),g=c.useRef(null);c.useEffect(()=>{p.current=!1},[k]);function D(i){const l=[...i].sort((e,C)=>new Date(e.date)-new Date(C.date));if(l.length&&_&&/^\d{4}-\d{2}-\d{2}$/.test(l[0].date))try{_(l[0].date)}catch{}const u=l.filter(e=>!(A&&e.date<A||j&&e.date>j));let s=0,n=0,a=0;const t=[],o=[],r=[],f=[];for(const e of u)!!e.abs?(s=e.manual||0,n=e.intelligence||0,a=e.endurance||0):(s+=e.manual||0,n+=e.intelligence||0,a+=e.endurance||0),t.push(e.date),o.push(s),r.push(n),f.push(a);L({labels:t,datasets:[b("line",0,o,{label:"Manual",pointRadius:3,showLine:!0,fill:!1,tension:.2}),b("line",1,r,{label:"Intelligence",pointRadius:3,showLine:!0,fill:!1,tension:.2}),b("line",2,f,{label:"Endurance",pointRadius:3,showLine:!0,fill:!1,tension:.2})]})}return c.useEffect(()=>{let i=!1;async function l(){return new Promise((s,n)=>{const a=window.indexedDB.open("WorkStatsDB",1);a.onupgradeneeded=t=>{const o=t.target.result;o.objectStoreNames.contains("work_stats")||o.createObjectStore("work_stats",{keyPath:"date"})},a.onsuccess=t=>s(t.target.result),a.onerror=t=>n(t.target.error)})}async function u(s){return new Promise(n=>{const t=s.transaction("work_stats","readonly").objectStore("work_stats").getAll();t.onsuccess=()=>n(t.result||[]),t.onerror=()=>n([])})}return(async()=>{S(!0);const s=await l();if(i)return;const n=await u(s),a=Array.isArray(n)?n:[];if(a.length&&(D(a),S(!1)),!p.current&&h){p.current=!0;const t=Math.floor(Date.now()/1e3),o=`${w}|${t}`;x.current=o;try{h(JSON.stringify({type:"companyTrainRange",from:w,to:t}))}catch{}a.length||(clearTimeout(g.current),g.current=setTimeout(()=>{if(R.current!==x.current&&m.current<3){m.current+=1,p.current=!1;try{const r=Math.floor(Date.now()/1e3);x.current=`${w}|${r}`,p.current=!0,h(JSON.stringify({type:"companyTrainRange",from:w,to:r}))}catch{}}},2e3*Math.max(1,m.current+1)))}})(),()=>{i=!0,clearTimeout(g.current)}},[k,h]),c.useEffect(()=>{if(!(!Array.isArray(d)||d.length===0))for(let i=d.length-1;i>=0;i--){const l=d[i];if(typeof l=="string"&&l.startsWith("{"))try{const u=JSON.parse(l);if(u.type==="companyTrainRange"&&Array.isArray(u.data)){const s=`${u.from}|${u.to}`;if(R.current===s)return;R.current=s,m.current=0,clearTimeout(g.current),(async()=>{const n=await new Promise((t,o)=>{const r=window.indexedDB.open("WorkStatsDB",1);r.onupgradeneeded=f=>{const e=f.target.result;e.objectStoreNames.contains("work_stats")||e.createObjectStore("work_stats",{keyPath:"date"})},r.onsuccess=f=>t(f.target.result),r.onerror=f=>o(f.target.error)});await Promise.all(u.data.map(t=>new Promise(o=>{const r=n.transaction("work_stats","readwrite");r.objectStore("work_stats").put(t).onsuccess=()=>o()})));const a=await new Promise(t=>{const r=n.transaction("work_stats","readonly").objectStore("work_stats").getAll();r.onsuccess=()=>t(r.result||[]),r.onerror=()=>t([])});D(a),S(!1)})();return}}catch{}}},[d]),y.jsxs("div",{className:"my-4",children:[y.jsx("h5",{style:{cursor:"pointer",userSelect:"none"},onClick:()=>B(i=>!i),title:"Click to show/hide chart",children:"Work Stats by Day"}),O?y.jsx("div",{children:"Loading..."}):$&&y.jsx("div",{style:{height:T},children:y.jsx(J,{data:E,options:N({responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0},title:{display:!1},tooltip:{enabled:!0}},scales:{x:{title:{display:!0,text:"Day"},type:"category"},y:{title:{display:!0,text:"Value"},beginAtZero:!0}}})})})]})}export{F as default};

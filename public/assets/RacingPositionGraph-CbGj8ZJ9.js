import{j as l,C as j,a as H}from"./index-BypqA20B.js";import{r as u}from"./vendor-react-BGsnWRWU.js";import{d as I,C as L,T as E,L as R,P as U,b as B,B as M,p as $,c as O}from"./vendor-chart-BMU4AhuH.js";import{u as G}from"./useChartTheme-0-n_Utvk.js";import"./chartTheme-DLOnjtYC.js";L.register(E,R,U,B,M,$,O);function N({logsUpdated:C,darkMode:p,chartHeight:w=j,dateFrom:d,dateTo:m,onMinDate:y}){const[f,x]=u.useState([]),[A,h]=u.useState(!0),[v,S]=u.useState(!0),[i,D]=u.useState("week"),{themedOptions:b}=G(p);u.useEffect(()=>{let s=!1;async function o(){h(!0);try{let n=await H(8731);n=n.filter(e=>{if(!e||typeof e.timestamp!="number")return!1;const t=e?.data?.position;return!!(typeof t=="string"&&t.length>0&&/[0-9]/.test(t[0]))}),n.sort((e,t)=>e.timestamp-t.timestamp);const c=n.map(e=>{const t=e.data.position[0],r=parseInt(t,10);return{x:e.timestamp*1e3,y:r}});if(c.length&&y){const e=new Date(c[0].x).toISOString().slice(0,10);if(/^\d{4}-\d{2}-\d{2}$/.test(e))try{y(e)}catch{}}s||x(c)}catch{s||x([])}finally{s||h(!1)}}return o(),()=>{s=!0}},[C,y]);const g=u.useMemo(()=>{if(!f.length)return{avg:[],counts:[]};const s=d||m?f.filter(o=>{const n=new Date(o.x).toISOString().slice(0,10);return!(d&&n<d||m&&n>m)}):f;if(i==="day"){const o=new Map;for(const e of s){const t=new Date(e.x);t.setUTCHours(0,0,0,0);const r=t.getTime(),a=o.get(r)||{sum:0,count:0};a.sum+=e.y,a.count+=1,o.set(r,a)}const n=Array.from(o.entries()).map(([e,t])=>({x:e,y:t.sum/t.count})).sort((e,t)=>e.x-t.x),c=Array.from(o.entries()).map(([e,t])=>({x:e,y:t.count})).sort((e,t)=>e.x-t.x);return{avg:n,counts:c}}if(i==="week"){let o=function(t){const r=new Date(t),a=r.getUTCDay(),P=a===0?6:a-1;return r.setUTCDate(r.getUTCDate()-P),r.setUTCHours(0,0,0,0),r.getTime()};const n=new Map;for(const t of s){const r=o(t.x),a=n.get(r)||{sum:0,count:0};a.sum+=t.y,a.count+=1,n.set(r,a)}const c=Array.from(n.entries()).map(([t,r])=>({x:t,y:r.sum/r.count})).sort((t,r)=>t.x-r.x),e=Array.from(n.entries()).map(([t,r])=>({x:t,y:r.count})).sort((t,r)=>t.x-r.x);return{avg:c,counts:e}}if(i==="month"){const o=new Map;for(const e of s){const t=new Date(e.x);t.setUTCDate(1),t.setUTCHours(0,0,0,0);const r=t.getTime(),a=o.get(r)||{sum:0,count:0};a.sum+=e.y,a.count+=1,o.set(r,a)}const n=Array.from(o.entries()).map(([e,t])=>({x:e,y:t.sum/t.count})).sort((e,t)=>e.x-t.x),c=Array.from(o.entries()).map(([e,t])=>({x:e,y:t.count})).sort((e,t)=>e.x-t.x);return{avg:n,counts:c}}return{avg:s,counts:s.map(o=>({x:o.x,y:1}))}},[f,i,d,m]),T=u.useMemo(()=>({datasets:[{type:"bar",label:`Avg Position (${i})`,data:g.avg,parsing:!1,backgroundColor:"rgba(6, 100, 100, 0.8)",borderColor:"rgba(1, 90, 90, 1)",borderWidth:1,barPercentage:.9,categoryPercentage:.9,yAxisID:"y"},{type:"bar",label:`Count (${i})`,data:g.counts,parsing:!1,backgroundColor:"rgba(180, 120, 30, 0.65)",borderColor:"rgba(160, 100, 20, 1)",borderWidth:1,barPercentage:.6,categoryPercentage:.6,yAxisID:"yCount"}]}),[g,i]),k=u.useMemo(()=>b({responsive:!0,maintainAspectRatio:!1,animation:!1,parsing:!1,scales:{x:{type:"time",time:{tooltipFormat:"yyyy-MM-dd HH:mm",displayFormats:{hour:"HH:mm",day:"yyyy-MM-dd"}},title:{display:!0,text:"Timestamp"}},y:{title:{display:!0,text:"Avg position (first digit)"},beginAtZero:!1},yCount:{position:"right",title:{display:!0,text:"Count"},beginAtZero:!0,grid:{drawOnChartArea:!1}}},plugins:{legend:{display:!0},tooltip:{callbacks:{title:s=>s.length?new Date(s[0].parsed.x).toLocaleString():"",label:s=>s.dataset.yAxisID==="y"?`Avg Position: ${s.parsed.y.toFixed?s.parsed.y.toFixed(2):s.parsed.y}`:`Count: ${s.parsed.y}`}}}}),[b]);return l.jsxs("div",{className:"my-4",style:{height:w,display:"flex",flexDirection:"column"},children:[l.jsxs("h5",{style:{cursor:"pointer",userSelect:"none",marginBottom:8},title:"Afficher / cacher",onClick:()=>S(s=>!s),children:["Racing Position – Avg & Count (",g.avg.length," ",i,g.avg.length>1?"s":"",", ",f.length," raw pts)"]}),A?l.jsx("div",{children:"Loading…"}):v&&l.jsxs("div",{style:{flex:1,position:"relative"},children:[l.jsx("div",{style:{position:"absolute",left:0,top:0,bottom:0,display:"flex",flexDirection:"column",gap:4,padding:4,zIndex:5},children:["day","week","month"].map(s=>l.jsx("button",{onClick:()=>D(s),style:{writingMode:"vertical-rl",transform:"rotate(180deg)",background:i===s?p?"#556":"#ddd":p?"#333":"#f6f6f6",color:p?"#fff":"#222",border:"1px solid "+(p?"#777":"#ccc"),borderRadius:4,cursor:"pointer",fontSize:11,padding:"6px 4px"},children:s},s))}),l.jsx("div",{style:{marginLeft:40,height:"100%"},children:l.jsx(I,{data:T,options:k})})]})]})}export{N as default};

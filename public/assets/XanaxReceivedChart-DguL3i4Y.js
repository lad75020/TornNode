import{j as r,o as E}from"./index-BypqA20B.js";import{r as p}from"./vendor-react-BGsnWRWU.js";import{u as Q}from"./useChartTheme-0-n_Utvk.js";import{c as X}from"./chartTheme-DLOnjtYC.js";import{d as q,C as G,a as Z,L as _,B as z,p as H,c as J}from"./vendor-chart-BMU4AhuH.js";G.register(Z,_,z,H,J);function ot({logsUpdated:$,darkMode:v,chartHeight:O=400,dateFrom:C,dateTo:b,onMinDate:f}){const[K,M]=p.useState({datasets:[]}),[A,D]=p.useState(!0),[N,L]=p.useState(!0),[P,W]=p.useState(null),[n,T]=p.useState("day"),{themedOptions:F,ds:U}=Q(v);return p.useEffect(()=>{async function y(){D(!0);const x=await E("LogsDB"),S="logs";if(!x.objectStoreNames.contains(S)){D(!1);return}const Y=await x.transaction(S).store.index("log").getAll(4103),o={},w=Date.UTC(2024,7,1);function k(a){const t=new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate())),l=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-l);const e=new Date(Date.UTC(t.getUTCFullYear(),0,1)),s=Math.ceil(((t-e)/864e5+1)/7);return{year:t.getUTCFullYear(),week:s}}for(const a of Y)if(a.data&&Array.isArray(a.data.items)&&a.data.items[0]&&a.data.items[0].id===206&&typeof a.data.items[0].qty=="number"&&typeof a.timestamp=="number"){const t=new Date(a.timestamp*1e3);if(t.getTime()<w)continue;const l=t.toISOString().slice(0,10);if(C&&l<C||b&&l>b)continue;let e,s;if(n==="day")e=t.toISOString().slice(0,10),s=Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate());else if(n==="week"){const{year:c,week:g}=k(t);e=`${c}-W${String(g).padStart(2,"0")}`;const i=new Date(Date.UTC(c,0,4)),m=i.getUTCDay()||7,h=new Date(i);h.setUTCDate(i.getUTCDate()-m+1);const j=new Date(h);j.setUTCDate(h.getUTCDate()+(g-1)*7),s=j.getTime()}else if(n==="month"){const c=t.getUTCFullYear(),g=t.getUTCMonth();e=`${c}-${String(g+1).padStart(2,"0")}`,s=Date.UTC(c,g,1)}o[e]||(o[e]={sum:0,sortKey:s}),o[e].sum+=a.data.items[0].qty}let u=[],d=[];if(Object.keys(o).length){if(n==="day"){const a=Object.entries(o).map(([e,s])=>({k:e,...s})).sort((e,s)=>e.sortKey-s.sortKey);let t=new Date(w);const l=new Date(a[a.length-1].sortKey);for(;t.getTime()<=l.getTime();){const e=t.toISOString().slice(0,10);u.push(e),d.push(o[e]?o[e].sum:0),t.setUTCDate(t.getUTCDate()+1)}}else if(n==="week"){let a=function(i){const{year:m,week:h}=k(i);return`${m}-W${String(h).padStart(2,"0")}`};const t=Object.entries(o).map(([i,m])=>({k:i,...m})).sort((i,m)=>i.sortKey-m.sortKey),l=new Date(w),e=l.getUTCDay()||7,s=new Date(l);s.setUTCDate(l.getUTCDate()-(e-1));let c=s;const g=new Date(t[t.length-1].sortKey);for(;c.getTime()<=g.getTime();){const i=a(c);u.push(i),d.push(o[i]?o[i].sum:0),c.setUTCDate(c.getUTCDate()+7)}}else if(n==="month"){const a=Object.entries(o).map(([e,s])=>({k:e,...s})).sort((e,s)=>e.sortKey-s.sortKey);let t=new Date(Date.UTC(2024,7,1));const l=new Date(a[a.length-1].sortKey);for(;t.getTime()<=l.getTime();){const e=`${t.getUTCFullYear()}-${String(t.getUTCMonth()+1).padStart(2,"0")}`;u.push(e),d.push(o[e]?o[e].sum:0),t.setUTCMonth(t.getUTCMonth()+1),t.setUTCDate(1)}}}const B=d.reduce((a,t)=>a+t,0);W(B);const{cumulative:I,average:R}=X(d);if(n==="day"&&u.length&&f&&/^\d{4}-\d{2}-\d{2}$/.test(u[0]))try{f(u[0])}catch{}M({labels:u,datasets:[U("bar",0,d,{label:"Xanax",backgroundColor:"rgba(153, 102, 255, 0.7)",borderColor:"rgba(153, 102, 255, 1)",borderWidth:1}),U("line",1,I,{label:"Cumul",borderColor:"rgba(255, 159, 64, 0.9)",backgroundColor:"rgba(255, 159, 64, 0.3)",yAxisID:"y1",pointRadius:2,tension:.15,fill:!1}),U("line",2,d.map(()=>R),{label:"Moyenne",borderColor:"rgba(54, 162, 235, 0.9)",backgroundColor:"rgba(54, 162, 235, 0.3)",borderDash:[6,4],pointRadius:0,tension:0,fill:!1})]}),D(!1)}y()},[$,n,C,b,f]),r.jsxs("div",{className:"my-4",children:[r.jsxs("h5",{style:{cursor:"pointer",userSelect:"none"},onClick:()=>L(y=>!y),title:"Click to show/hide chart",children:["Xanax reÃ§us par ",n]}),A?r.jsx("div",{children:r.jsx("img",{src:"/images/loader.gif",alt:"Chargement...",style:{maxWidth:"80px"}})}):N&&r.jsx(r.Fragment,{children:r.jsxs("div",{style:{display:"flex",gap:"8px",height:O},children:[r.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:r.jsxs("div",{className:"btn-group-vertical",role:"group","aria-label":"Granularity",children:[r.jsx("button",{type:"button",className:`btn btn-sm ${n==="day"?"btn-primary":"btn-outline-primary"}`,onClick:()=>T("day"),children:"Daily"}),r.jsx("button",{type:"button",className:`btn btn-sm ${n==="week"?"btn-primary":"btn-outline-primary"}`,onClick:()=>T("week"),children:"Weekly"}),r.jsx("button",{type:"button",className:`btn btn-sm ${n==="month"?"btn-primary":"btn-outline-primary"}`,onClick:()=>T("month"),children:"Monthly"})]})}),r.jsx("div",{style:{flex:1},children:r.jsx(q,{data:K,options:F({responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0},tooltip:{callbacks:{label(y){return`${y.dataset.label||""}: ${y.parsed.y}`}}}},scales:{x:{title:{display:!0,text:n.charAt(0).toUpperCase()+n.slice(1)}},y:{title:{display:!0,text:"Qty"},beginAtZero:!0},y1:{position:"right",title:{display:!0,text:"Cumul"},beginAtZero:!0,grid:{drawOnChartArea:!1}}}})})})]})})]})}export{ot as default};

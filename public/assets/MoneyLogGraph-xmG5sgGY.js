import{j as i,a as Y}from"./index-BypqA20B.js";import{r as p}from"./vendor-react-BGsnWRWU.js";import{u as I}from"./useChartTheme-0-n_Utvk.js";import{c as k}from"./chartTheme-DLOnjtYC.js";import{d as R,C as G,a as _,L as P,B as Z,b as H,P as q,e as z,p as J,c as Q}from"./vendor-chart-BMU4AhuH.js";import{f as V}from"./dateFilterUtil-DgyJ2LTd.js";G.register(_,P,Z,H,q,z,J,Q);function oe({logsUpdated:j,darkMode:M,chartHeight:K=400,dateFrom:$,dateTo:v,onMinDate:D}){const[h,L]=p.useState({labels:[],sums:[]}),[O,N]=p.useState(!0),[A,U]=p.useState(!0),[r,b]=p.useState("day"),{themedOptions:F,ds:w}=I(M);p.useEffect(()=>{async function c(){U(!0);let m=await Y(4810);const W=Date.UTC(2024,7,1);m=m.filter(t=>{if(t.timestamp*1e3<W)return!1;const a=t?.data?.money??t?.money??0;return!(Math.abs(Number(a)||0)>2e7)});const o={};function f(t,e,a){o[t]||(o[t]={sum:0,sortKey:e}),o[t].sum+=Number(a)||0}function S(t){const e=new Date(Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate())),a=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-a);const n=new Date(Date.UTC(e.getUTCFullYear(),0,1)),s=Math.ceil(((e-n)/864e5+1)/7);return{year:e.getUTCFullYear(),week:s}}for(const t of m){const e=t.timestamp*1e3,a=new Date(e),n=t?.data?.money??t?.money??0;if(r==="day"){const s=a.toISOString().slice(0,10),l=Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate());f(s,l,n)}else if(r==="week"){const{year:s,week:l}=S(a),y=`${s}-W${String(l).padStart(2,"0")}`,g=new Date(Date.UTC(s,0,4)),B=g.getUTCDay()||7,T=new Date(g);T.setUTCDate(g.getUTCDate()-B+1);const x=new Date(T);x.setUTCDate(T.getUTCDate()+(l-1)*7);const E=x.getTime();f(y,E,n)}else if(r==="month"){const s=a.getUTCFullYear(),l=a.getUTCMonth(),y=`${s}-${String(l+1).padStart(2,"0")}`,g=Date.UTC(s,l,1);f(y,g,n)}}let u=[],d=[];if(Object.keys(o).length===0)u=[],d=[];else if(r==="day"){const t=Object.entries(o).map(([n,s])=>({k:n,...s}));t.sort((n,s)=>n.sortKey-s.sortKey);let e=new Date(t[0].sortKey);const a=new Date(t[t.length-1].sortKey);for(;e.getTime()<=a.getTime();){const n=e.toISOString().slice(0,10);u.push(n),d.push(o[n]?o[n].sum:0),e.setUTCDate(e.getUTCDate()+1)}}else if(r==="week"){let t=function(s){const{year:l,week:y}=S(s);return`${l}-W${String(y).padStart(2,"0")}`};const e=Object.entries(o).map(([s,l])=>({k:s,...l}));e.sort((s,l)=>s.sortKey-l.sortKey);let a=new Date(e[0].sortKey);a.setUTCHours(0,0,0,0);const n=new Date(e[e.length-1].sortKey);for(;a.getTime()<=n.getTime();){const s=t(a);u.push(s),d.push(o[s]?o[s].sum:0),a.setUTCDate(a.getUTCDate()+7)}}else if(r==="month"){const t=Object.entries(o).map(([n,s])=>({k:n,...s}));t.sort((n,s)=>n.sortKey-s.sortKey);let e=new Date(t[0].sortKey);const a=new Date(t[t.length-1].sortKey);for(;e.getTime()<=a.getTime();){const n=`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}`;u.push(n),d.push(o[n]?o[n].sum:0),e.setUTCMonth(e.getUTCMonth()+1),e.setUTCDate(1)}}if(u.length&&D&&/^\d{4}-\d{2}-\d{2}$/.test(u[0]))try{D(u[0])}catch{}L({labels:u,sums:d}),U(!1)}c()},[j,r]);const C=(()=>{const{labels:c,datasets:m}=V(h.labels,[{label:"Sum",data:h.sums}],$,v);return{labels:c,sums:m[0].data}})(),{cumulative:X}=k(h.sums);return i.jsxs("div",{className:"my-4",children:[i.jsxs("h5",{style:{cursor:"pointer",userSelect:"none"},onClick:()=>N(c=>!c),title:"Click to show/hide chart",children:["Money Received per ",r]}),A?i.jsx("div",{children:i.jsx("img",{src:"/images/loader.gif",alt:"Loading...",style:{maxWidth:"80px"}})}):O&&i.jsxs("div",{style:{display:"flex",gap:8,height:K},children:[i.jsx("div",{style:{display:"flex",flexDirection:"column",gap:6},children:i.jsxs("div",{className:"btn-group-vertical",role:"group","aria-label":"Granularity",children:[i.jsx("button",{type:"button",className:`btn btn-sm ${r==="day"?"btn-primary":"btn-outline-primary"}`,onClick:()=>b("day"),children:"Daily"}),i.jsx("button",{type:"button",className:`btn btn-sm ${r==="week"?"btn-primary":"btn-outline-primary"}`,onClick:()=>b("week"),children:"Weekly"}),i.jsx("button",{type:"button",className:`btn btn-sm ${r==="month"?"btn-primary":"btn-outline-primary"}`,onClick:()=>b("month"),children:"Monthly"})]})}),i.jsx("div",{style:{flex:1},children:i.jsx(R,{data:{labels:C.labels,datasets:[w("bar",0,C.sums,{label:"Sum",backgroundColor:"rgba(54,162,235,0.6)",borderColor:"rgba(54,162,235,1)",borderWidth:1}),w("line",1,k(C.sums).cumulative,{label:"Cumulative",borderColor:"rgba(255,159,64,0.9)",backgroundColor:"rgba(255,159,64,0.3)",yAxisID:"y1",pointRadius:2,tension:.15,fill:!1})]},options:F({responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0},title:{display:!1},tooltip:{callbacks:{label(c){return`${c.dataset.label||""}: ${c.parsed.y?.toLocaleString?.()??c.parsed.y}`}}}},scales:{x:{title:{display:!0,text:r.charAt(0).toUpperCase()+r.slice(1)}},y:{title:{display:!0,text:"Amount"},beginAtZero:!0},y1:{position:"right",title:{display:!0,text:"Cumulative"},beginAtZero:!0,grid:{drawOnChartArea:!1}}}})})})]})]})}export{oe as default};

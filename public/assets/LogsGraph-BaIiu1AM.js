import{j as r,o as G}from"./index-BypqA20B.js";import{r as y}from"./vendor-react-BGsnWRWU.js";import{f as _}from"./dateFilterUtil-DgyJ2LTd.js";import{u as Z}from"./useChartTheme-0-n_Utvk.js";import{c as j}from"./chartTheme-DLOnjtYC.js";import{d as H,C as q,a as z,L as J,B as P,e as Q,p as V,c as X}from"./vendor-chart-BMU4AhuH.js";q.register(z,J,P,Q,V,X);function gt({token:tt,onAuth:et,logsUpdated:K,darkMode:v,chartHeight:$=400,dateFrom:M,dateTo:O,onMinDate:U}){const[b,A]=y.useState({labels:[],counts:[]}),[F,L]=y.useState(!0),[N,h]=y.useState(!0),[st,B]=y.useState(null),[o,C]=y.useState("day"),{themedOptions:W,ds:f}=Z(v);y.useEffect(()=>{async function c(){h(!0);const p=await G("LogsDB"),w="logs";if(!p.objectStoreNames.contains(w)){h(!1);return}const Y=await p.transaction(w).store.index("log").getAll(5410),l={};function T(a,t){l[a]||(l[a]={count:0,sortKey:t}),l[a].count+=1}function k(a){const t=new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate())),n=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-n);const e=new Date(Date.UTC(t.getUTCFullYear(),0,1)),s=Math.ceil(((t-e)/864e5+1)/7);return{year:t.getUTCFullYear(),week:s}}for(const a of Y){const t=a.timestamp*1e3,n=new Date(t);if(o==="day"){const e=n.toISOString().slice(0,10),s=Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate());T(e,s)}else if(o==="week"){const{year:e,week:s}=k(n),i=`${e}-W${String(s).padStart(2,"0")}`,d=new Date(Date.UTC(e,0,4)),E=d.getUTCDay()||7,D=new Date(d);D.setUTCDate(d.getUTCDate()-E+1);const S=new Date(D);S.setUTCDate(D.getUTCDate()+(s-1)*7);const I=S.getTime();T(i,I)}else if(o==="month"){const e=n.getUTCFullYear(),s=n.getUTCMonth(),i=`${e}-${String(s+1).padStart(2,"0")}`,d=Date.UTC(e,s,1);T(i,d)}}let u=[],g=[];if(Object.keys(l).length===0)u=[],g=[];else if(o==="day"){const a=Object.entries(l).map(([e,s])=>({k:e,...s}));a.sort((e,s)=>e.sortKey-s.sortKey);let t=new Date(a[0].sortKey);const n=new Date(a[a.length-1].sortKey);for(;t.getTime()<=n.getTime();){const e=t.toISOString().slice(0,10);u.push(e),g.push(l[e]?l[e].count:0),t.setUTCDate(t.getUTCDate()+1)}}else if(o==="week"){let a=function(s){const{year:i,week:d}=k(s);return`${i}-W${String(d).padStart(2,"0")}`};const t=Object.entries(l).map(([s,i])=>({k:s,...i}));t.sort((s,i)=>s.sortKey-i.sortKey);let n=new Date(t[0].sortKey);n.setUTCHours(0,0,0,0);const e=new Date(t[t.length-1].sortKey);for(;n.getTime()<=e.getTime();){const s=a(n);u.push(s),g.push(l[s]?l[s].count:0),n.setUTCDate(n.getUTCDate()+7)}}else if(o==="month"){const a=Object.entries(l).map(([e,s])=>({k:e,...s}));a.sort((e,s)=>e.sortKey-s.sortKey);let t=new Date(a[0].sortKey);const n=new Date(a[a.length-1].sortKey);for(;t.getTime()<=n.getTime();){const e=`${t.getUTCFullYear()}-${String(t.getUTCMonth()+1).padStart(2,"0")}`;u.push(e),g.push(l[e]?l[e].count:0),t.setUTCMonth(t.getUTCMonth()+1),t.setUTCDate(1)}}if(u.length&&o==="day"&&U&&/^\d{4}-\d{2}-\d{2}$/.test(u[0]))try{U(u[0])}catch{}A({labels:u,counts:g});const R=g.reduce((a,t)=>a+t,0);B(R),h(!1)}c()},[K,o]);const{cumulative:at,average:nt}=j(b.counts),m=(()=>{const{labels:c,datasets:p}=_(b.labels,[{label:"Count",data:b.counts}],M,O);return{labels:c,counts:p[0].data}})(),x=j(m.counts);return r.jsxs("div",{className:"my-4",children:[r.jsxs("h5",{style:{cursor:"pointer",userSelect:"none"},onClick:()=>L(c=>!c),title:"Click to show/hide chart",children:["Revives per ",o]}),N?r.jsx("div",{children:r.jsx("img",{src:"/images/loader.gif",alt:"Chargement...",style:{maxWidth:"80px"}})}):F&&r.jsx(r.Fragment,{children:r.jsxs("div",{style:{display:"flex",gap:"8px",height:$},children:[r.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:r.jsxs("div",{className:"btn-group-vertical",role:"group","aria-label":"Granularity",children:[r.jsx("button",{type:"button",className:`btn btn-sm ${o==="day"?"btn-primary":"btn-outline-primary"}`,onClick:()=>C("day"),children:"Daily"}),r.jsx("button",{type:"button",className:`btn btn-sm ${o==="week"?"btn-primary":"btn-outline-primary"}`,onClick:()=>C("week"),children:"Weekly"}),r.jsx("button",{type:"button",className:`btn btn-sm ${o==="month"?"btn-primary":"btn-outline-primary"}`,onClick:()=>C("month"),children:"Monthly"})]})}),r.jsx("div",{style:{flex:1},children:r.jsx(H,{data:{labels:m.labels,datasets:[f("bar",0,m.counts,{label:"Count",backgroundColor:"rgba(75,192,192,0.6)",borderColor:"rgba(75,192,192,1)",borderWidth:1}),f("line",1,x.cumulative,{label:"Cumul",borderColor:"rgba(255, 159, 64, 0.9)",backgroundColor:"rgba(255, 159, 64, 0.3)",yAxisID:"y1",pointRadius:2,tension:.15,fill:!1}),f("line",2,m.counts.map(()=>x.average),{label:"Moyenne",borderColor:"rgba(153, 102, 255, 0.9)",backgroundColor:"rgba(153, 102, 255, 0.3)",borderDash:[6,4],pointRadius:0,tension:0,fill:!1})]},options:W({responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0},title:{display:!1},tooltip:{callbacks:{label(c){return`${c.dataset.label||""}: ${c.parsed.y}`}}}},scales:{x:{title:{display:!0,text:o.charAt(0).toUpperCase()+o.slice(1)}},y:{title:{display:!0,text:"Count"},beginAtZero:!0},y1:{position:"right",title:{display:!0,text:"Cumul"},beginAtZero:!0,grid:{drawOnChartArea:!1}}}})})})]})})]})}export{gt as default};

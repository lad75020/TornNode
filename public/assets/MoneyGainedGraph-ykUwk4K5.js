import{j as l,a as G}from"./index-BypqA20B.js";import{r as g}from"./vendor-react-BGsnWRWU.js";import{f as I}from"./dateFilterUtil-DgyJ2LTd.js";import{u as _}from"./useChartTheme-0-n_Utvk.js";import{c as K}from"./chartTheme-DLOnjtYC.js";import{d as R,C as P,a as Z,L as q,B as z,b as H,P as J,e as Q,p as V,c as X}from"./vendor-chart-BMU4AhuH.js";P.register(Z,q,z,H,J,Q,V,X);function le({logsUpdated:$,darkMode:v,chartHeight:L=400,dateFrom:M,dateTo:E,onMinDate:w}){const[h,S]=g.useState({labels:[],sums:[]}),[F,N]=g.useState(!0),[O,b]=g.useState(!0),[n,C]=g.useState("day"),{themedOptions:W,ds:x}=_(v);g.useEffect(()=>{async function c(){b(!0);let m=await G(9015);m=m.filter(e=>e&&e.data&&typeof e.data.money_gained<"u");const i={};function T(e,s,t){i[e]||(i[e]={sum:0,sortKey:s}),i[e].sum+=Number(t)||0}function k(e){const s=new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())),t=s.getUTCDay()||7;s.setUTCDate(s.getUTCDate()+4-t);const a=new Date(Date.UTC(s.getUTCFullYear(),0,1)),o=Math.ceil(((s-a)/864e5+1)/7);return{year:s.getUTCFullYear(),week:o}}for(const e of m){const s=e.timestamp*1e3,t=new Date(s),a=e.data.money_gained;if(n==="day"){const o=t.toISOString().slice(0,10),u=Date.UTC(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate());T(o,u,a)}else if(n==="week"){const{year:o,week:u}=k(t),D=`${o}-W${String(u).padStart(2,"0")}`,y=new Date(Date.UTC(o,0,4)),B=y.getUTCDay()||7,U=new Date(y);U.setUTCDate(y.getUTCDate()-B+1);const j=new Date(U);j.setUTCDate(U.getUTCDate()+(u-1)*7);const Y=j.getTime();T(D,Y,a)}else if(n==="month"){const o=t.getUTCFullYear(),u=t.getUTCMonth(),D=`${o}-${String(u+1).padStart(2,"0")}`,y=Date.UTC(o,u,1);T(D,y,a)}}let d=[],p=[];const r=Object.entries(i).map(([e,s])=>({k:e,...s}));if(r.length===0){S({labels:[],sums:[]}),b(!1);return}if(n==="day"){r.sort((t,a)=>t.sortKey-a.sortKey);let e=new Date(r[0].sortKey);const s=new Date(r[r.length-1].sortKey);for(;e.getTime()<=s.getTime();){const t=e.toISOString().slice(0,10);d.push(t),p.push(i[t]?i[t].sum:0),e.setUTCDate(e.getUTCDate()+1)}}else if(n==="week"){let e=function(a){const{year:o,week:u}=k(a);return`${o}-W${String(u).padStart(2,"0")}`};r.sort((a,o)=>a.sortKey-o.sortKey);let s=new Date(r[0].sortKey);const t=new Date(r[r.length-1].sortKey);for(;s.getTime()<=t.getTime();){const a=e(s);d.push(a),p.push(i[a]?i[a].sum:0),s.setUTCDate(s.getUTCDate()+7)}}else if(n==="month"){r.sort((t,a)=>t.sortKey-a.sortKey);let e=new Date(r[0].sortKey);const s=new Date(r[r.length-1].sortKey);for(;e.getTime()<=s.getTime();){const t=`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}`;d.push(t),p.push(i[t]?i[t].sum:0),e.setUTCMonth(e.getUTCMonth()+1),e.setUTCDate(1)}}if(d.length&&n==="day"&&w&&/^\d{4}-\d{2}-\d{2}$/.test(d[0]))try{w(d[0])}catch{}S({labels:d,sums:p}),b(!1)}c()},[$,n]);const{cumulative:ee}=K(h.sums),f=(()=>{const{labels:c,datasets:m}=I(h.labels,[{label:"Sum",data:h.sums}],M,E);return{labels:c,sums:m[0].data}})(),A=K(f.sums);return l.jsxs("div",{className:"my-4",children:[l.jsxs("h5",{style:{cursor:"pointer",userSelect:"none"},onClick:()=>N(c=>!c),title:"Click to show/hide chart",children:["Crime Money per ",n]}),O?l.jsx("div",{children:l.jsx("img",{src:"/images/loader.gif",alt:"Loading...",style:{maxWidth:"80px"}})}):F&&l.jsxs("div",{style:{display:"flex",gap:8,height:L},children:[l.jsx("div",{style:{display:"flex",flexDirection:"column",gap:6},children:l.jsxs("div",{className:"btn-group-vertical",role:"group","aria-label":"Granularity",children:[l.jsx("button",{type:"button",className:`btn btn-sm ${n==="day"?"btn-primary":"btn-outline-primary"}`,onClick:()=>C("day"),children:"Daily"}),l.jsx("button",{type:"button",className:`btn btn-sm ${n==="week"?"btn-primary":"btn-outline-primary"}`,onClick:()=>C("week"),children:"Weekly"}),l.jsx("button",{type:"button",className:`btn btn-sm ${n==="month"?"btn-primary":"btn-outline-primary"}`,onClick:()=>C("month"),children:"Monthly"})]})}),l.jsx("div",{style:{flex:1},children:l.jsx(R,{data:{labels:f.labels,datasets:[x("bar",0,f.sums,{label:"Sum",backgroundColor:"rgba(75,192,192,0.6)",borderColor:"rgba(75,192,192,1)",borderWidth:1}),x("line",1,A.cumulative,{label:"Cumulative",borderColor:"rgba(153,102,255,0.9)",backgroundColor:"rgba(153,102,255,0.3)",yAxisID:"y1",pointRadius:2,tension:.15,fill:!1})]},options:W({responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0},title:{display:!1},tooltip:{callbacks:{label(c){return`${c.dataset.label||""}: ${c.parsed.y?.toLocaleString?.()??c.parsed.y}`}}}},scales:{x:{title:{display:!0,text:n.charAt(0).toUpperCase()+n.slice(1)}},y:{title:{display:!0,text:"Gained"},beginAtZero:!0},y1:{position:"right",title:{display:!0,text:"Cumulative"},beginAtZero:!0,grid:{drawOnChartArea:!1}}}})})})]})]})}export{le as default};

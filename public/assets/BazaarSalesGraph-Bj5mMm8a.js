import{j as o,o as R}from"./index-BypqA20B.js";import{r as m}from"./vendor-react-BGsnWRWU.js";import{f as _}from"./dateFilterUtil-DgyJ2LTd.js";import{u as G}from"./useChartTheme-0-n_Utvk.js";import{c as z}from"./chartTheme-DLOnjtYC.js";import{d as Z,C as q,a as H,L as J,g as P,B as Q,p as V,c as X}from"./vendor-chart-BMU4AhuH.js";q.register(H,J,P,Q,V,X);function ce({logsUpdated:S,darkMode:w,chartHeight:k=400,dateFrom:j,dateTo:K,onMinDate:C}){const[$,v]=m.useState({datasets:[]}),[O,g]=m.useState(!0),[M,B]=m.useState(!0),[ee,F]=m.useState(null),[n,y]=m.useState("day"),{themedOptions:N,ds:p}=G(w);return m.useEffect(()=>{async function h(){g(!0);const f=await R("LogsDB"),D="logs";if(!f.objectStoreNames.contains(D)){g(!1);return}const A=await f.transaction(D).store.index("log").getAll(1226),l={};function T(s){const e=new Date(Date.UTC(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate())),r=e.getUTCDay()||7;e.setUTCDate(e.getUTCDate()+4-r);const a=new Date(Date.UTC(e.getUTCFullYear(),0,1)),t=Math.ceil(((e-a)/864e5+1)/7);return{year:e.getUTCFullYear(),week:t}}for(const s of A)if(s.data&&typeof s.data.cost_total=="number"&&typeof s.timestamp=="number"){const e=new Date(s.timestamp*1e3);let r,a;if(n==="day")r=e.toISOString().slice(0,10),a=Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate());else if(n==="week"){const{year:t,week:i}=T(e);r=`${t}-W${String(i).padStart(2,"0")}`;const d=new Date(Date.UTC(t,0,4)),I=d.getUTCDay()||7,b=new Date(d);b.setUTCDate(d.getUTCDate()-I+1);const U=new Date(b);U.setUTCDate(b.getUTCDate()+(i-1)*7),a=U.getTime()}else if(n==="month"){const t=e.getUTCFullYear(),i=e.getUTCMonth();r=`${t}-${String(i+1).padStart(2,"0")}`,a=Date.UTC(t,i,1)}l[r]||(l[r]={sum:0,sortKey:a}),l[r].sum+=s.data.cost_total}let c=[],u=[];if(Object.keys(l).length){if(n==="day"){const s=Object.entries(l).map(([a,t])=>({k:a,...t})).sort((a,t)=>a.sortKey-t.sortKey);let e=new Date(s[0].sortKey);const r=new Date(s[s.length-1].sortKey);for(;e.getTime()<=r.getTime();){const a=e.toISOString().slice(0,10);c.push(a),u.push(l[a]?l[a].sum:0),e.setUTCDate(e.getUTCDate()+1)}}else if(n==="week"){let s=function(t){const{year:i,week:d}=T(t);return`${i}-W${String(d).padStart(2,"0")}`};const e=Object.entries(l).map(([t,i])=>({k:t,...i})).sort((t,i)=>t.sortKey-i.sortKey);let r=new Date(e[0].sortKey);const a=new Date(e[e.length-1].sortKey);for(;r.getTime()<=a.getTime();){const t=s(r);c.push(t),u.push(l[t]?l[t].sum:0),r.setUTCDate(r.getUTCDate()+7)}}else if(n==="month"){const s=Object.entries(l).map(([a,t])=>({k:a,...t})).sort((a,t)=>a.sortKey-t.sortKey);let e=new Date(s[0].sortKey);const r=new Date(s[s.length-1].sortKey);for(;e.getTime()<=r.getTime();){const a=`${e.getUTCFullYear()}-${String(e.getUTCMonth()+1).padStart(2,"0")}`;c.push(a),u.push(l[a]?l[a].sum:0),e.setUTCMonth(e.getUTCMonth()+1),e.setUTCDate(1)}}}const W=u.reduce((s,e)=>s+e,0);F(W);const{cumulative:L,average:Y}=z(u);if(n==="day"&&c.length&&C&&/^\d{4}-\d{2}-\d{2}$/.test(c[0]))try{C(c[0])}catch{}let x=[p("bar",0,u,{label:"Sales",backgroundColor:"rgba(75, 192, 192, 0.7)",borderColor:"rgba(75, 192, 192, 1)",borderWidth:1}),p("line",1,L,{label:"Cumul",borderColor:"rgba(255, 159, 64, 0.9)",backgroundColor:"rgba(255, 159, 64, 0.3)",yAxisID:"y1",pointRadius:2,tension:.15,fill:!1}),p("line",2,u.map(()=>Y),{label:"Moyenne",borderColor:"rgba(153, 102, 255, 0.9)",backgroundColor:"rgba(153, 102, 255, 0.3)",borderDash:[6,4],pointRadius:0,tension:0,fill:!1})];const E=n==="day"?_(c,x,j,K):{labels:c,datasets:x};v(E),g(!1)}h()},[S,n]),o.jsxs("div",{className:"my-4",children:[o.jsxs("h5",{style:{cursor:"pointer",userSelect:"none"},onClick:()=>B(h=>!h),title:"Click to show/hide chart",children:["Bazaar sales per ",n]}),O?o.jsx("div",{children:o.jsx("img",{src:"/images/loader.gif",alt:"Chargement...",style:{maxWidth:"80px"}})}):M&&o.jsx(o.Fragment,{children:o.jsxs("div",{style:{display:"flex",gap:"8px",height:k},children:[o.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"6px"},children:o.jsxs("div",{className:"btn-group-vertical",role:"group","aria-label":"Granularity",children:[o.jsx("button",{type:"button",className:`btn btn-sm ${n==="day"?"btn-primary":"btn-outline-primary"}`,onClick:()=>y("day"),children:"Daily"}),o.jsx("button",{type:"button",className:`btn btn-sm ${n==="week"?"btn-primary":"btn-outline-primary"}`,onClick:()=>y("week"),children:"Weekly"}),o.jsx("button",{type:"button",className:`btn btn-sm ${n==="month"?"btn-primary":"btn-outline-primary"}`,onClick:()=>y("month"),children:"Monthly"})]})}),o.jsx("div",{style:{flex:1},children:o.jsx(Z,{data:$,options:N({responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0},tooltip:{enabled:!0}},scales:{x:{title:{display:!0,text:n.charAt(0).toUpperCase()+n.slice(1)}},y:{title:{display:!0,text:"Total sales"},beginAtZero:!0,type:"logarithmic",min:1},y1:{position:"right",title:{display:!0,text:"Cumul"},beginAtZero:!0,grid:{drawOnChartArea:!1}}}})})})]})})]})}export{ce as default};

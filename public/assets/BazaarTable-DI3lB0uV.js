import{j as t,o as w}from"./index-BypqA20B.js";import{r as o}from"./vendor-react-BGsnWRWU.js";import"./vendor-chart-BMU4AhuH.js";function P({bazaarRows:r,watchedItems:a,priceThresholds:m,blinkingItems:g,onThresholdChange:y,onUnwatch:b,sendWs:S}){const h=o.useRef(new Map),[d,j]=o.useState({}),f=o.useRef(new Map);async function I(e,i,n){try{const l=(await w("ItemsDB",1,{upgrade(x){x.objectStoreNames.contains("items")||x.createObjectStore("items",{keyPath:"id"})}})).transaction("items","readwrite"),c=l.store,s=await c.get(e)||{id:e};(i&&typeof i=="string"&&i.trim()&&i!==s.name||!s.name&&i)&&(s.name=i),s.price=n,s._updatedAt=Date.now(),await c.put(s),await l.done}catch(p){console.warn("[BazaarTable] Échec maj ItemsDB",e,p.message)}}o.useEffect(()=>{const e={};for(const i of r){if(!a.includes(i.itemId))continue;const n=h.current.get(i.itemId);typeof n=="number"&&typeof i.price=="number"?i.price>n?e[i.itemId]="up":i.price<n?e[i.itemId]="down":e[i.itemId]="same":e[i.itemId]="same"}for(const i of r)typeof i.price=="number"&&h.current.set(i.itemId,i.price);j(e)},[r,a]),o.useEffect(()=>{for(const e of r){if(!a.includes(e.itemId)||typeof e.price!="number"||e.price<=0)continue;const i=f.current.get(e.itemId),n=d[e.itemId];(n==="up"||n==="down"||i==null)&&i!==e.price&&(I(e.itemId,e.itemName,e.price),f.current.set(e.itemId,e.price))}},[d,r,a]);const u=r.filter(e=>a.includes(e.itemId));return u.length?t.jsxs("div",{className:"mb-4",children:[t.jsx("h5",{children:"Market Lowest price"}),t.jsx("div",{style:{maxHeight:260,overflowY:"auto",overflowX:"auto",border:"1px solid #ddd",borderRadius:4},children:t.jsxs("table",{className:"table table-sm table-striped table-hover mb-0",style:{fontSize:12},children:[t.jsx("thead",{className:"table-light",style:{position:"sticky",top:0},children:t.jsxs("tr",{children:[t.jsx("th",{style:{width:160},children:"Item"}),t.jsx("th",{style:{width:110},children:"Price"}),t.jsx("th",{style:{width:52,textAlign:"center"},children:"Δ"}),t.jsx("th",{style:{width:80},children:"Qty"}),t.jsx("th",{style:{width:110},children:"Threshold"}),t.jsx("th",{style:{width:46},children:"Open"}),t.jsx("th",{style:{width:30}})]})}),t.jsx("tbody",{children:u.map((e,i)=>{const n=Number(m[e.itemId]||0),p=e.price<n&&n>0;return t.jsxs("tr",{className:(p?"bazaar-alert ":"")+(g.has(e.itemId)?"bazaar-blink":""),children:[t.jsxs("td",{children:[e.itemName||e.itemId,t.jsxs("div",{style:{fontSize:10,opacity:.6},children:["#",e.itemId]})]}),t.jsx("td",{children:e.price?.toLocaleString?.()??e.price}),t.jsxs("td",{style:{textAlign:"center",padding:"0 4px"},children:[d[e.itemId]==="down"&&t.jsx("span",{style:{color:"#0d8d20",fontWeight:500,fontSize:40,lineHeight:"42px",display:"inline-block",transform:"translateY(4px)"},title:"Prix en baisse","aria-label":"Prix en baisse",children:"↓"}),d[e.itemId]==="up"&&t.jsx("span",{style:{color:"#c40000",fontWeight:500,fontSize:40,lineHeight:"42px",display:"inline-block",transform:"translateY(4px)"},title:"Prix en hausse","aria-label":"Prix en hausse",children:"↑"})]}),t.jsx("td",{children:e.quantity}),t.jsx("td",{children:t.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",value:m[e.itemId]??0,onChange:l=>{const c=(l.target.value||"").replace(/\D+/g,"");y(e.itemId,c===""?0:Number(c))},style:{width:"100%",fontSize:11,padding:2,textAlign:"right"}})}),t.jsx("td",{children:t.jsx("button",{onClick:()=>{const l=`https://www.torn.com/page.php?sid=ItemMarket#/market/view=search&itemID=${e.itemId}`;try{window.open(l,"tornMarket","noopener,noreferrer")}catch{}},className:"btn btn-sm btn-outline-primary",style:{padding:"2px 6px",lineHeight:1,display:"inline-flex",alignItems:"center",gap:2,fontSize:11},title:"Ouvrir la page market de cet item","aria-label":`Open market for item ${e.itemId}`,children:t.jsx("span",{style:{fontSize:12},children:"↗"})})}),t.jsx("td",{children:t.jsx("button",{onClick:()=>b(e.itemId),style:{background:"transparent",border:"none",color:"#c40000",fontWeight:700,fontSize:14,lineHeight:1,padding:0,cursor:"pointer"},"aria-label":`Remove item ${e.itemId}`,title:"Stop watching",children:"✖"})})]},i)})})]})})]}):null}export{P as default};
